{"kind":"article","schemaVersion":{"major":0,"patch":0,"minor":3},"seeAlsoSections":[{"title":"Essentials","generated":true,"anchor":"Essentials","identifiers":["doc:\/\/VernissageServer\/documentation\/VernissageServer\/HostVernissageServer","doc:\/\/VernissageServer\/documentation\/VernissageServer\/HostVernissageWeb","doc:\/\/VernissageServer\/documentation\/VernissageServer\/BuildDocumentation","doc:\/\/VernissageServer\/documentation\/VernissageServer\/ContentFeeds"]}],"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/VernissageServer\/documentation\/VernissageServer\/DockerContainers"},"sections":[],"metadata":{"title":"Hosting Vernissage in Docker containers","modules":[{"name":"VernissageServer"}],"role":"article","roleHeading":"Article"},"abstract":[{"text":"This documentation describes how to run Vernissage in your custom Docker container hosting provider using ","type":"text"},{"type":"codeVoice","code":"docker compose"},{"type":"text","text":"."}],"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/vernissageserver\/dockercontainers"]}],"primaryContentSections":[{"kind":"content","content":[{"text":"Overview","type":"heading","level":2,"anchor":"overview"},{"inlineContent":[{"text":"The configuration consists of a ","type":"text"},{"inlineContent":[{"type":"text","text":"docker-compose.yml"}],"type":"emphasis"},{"type":"text","text":" and a "},{"type":"emphasis","inlineContent":[{"type":"text","text":".env"}]},{"type":"text","text":" file."}],"type":"paragraph"},{"level":2,"text":"Installation","anchor":"Installation","type":"heading"},{"anchor":"docker-compose","level":3,"text":"docker compose","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"First install docker and docker compose. On Debian based systems:","type":"text"}]},{"code":["apt update","apt install docker.io docker-compose-v2"],"type":"codeListing","syntax":null},{"inlineContent":[{"text":"Package names may vary, please refer to the documentation of your distribution.","type":"text"}],"type":"paragraph"},{"type":"heading","level":3,"anchor":"HOME","text":"HOME"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Then create an empty directory of your choosing, e.g. "},{"type":"codeVoice","code":"\/opt\/vernissage"},{"text":". This directory is the home of your deployment and holds both the configuration files described below. This document will use the name ","type":"text"},{"inlineContent":[{"type":"text","text":"HOME"}],"type":"strong"},{"type":"text","text":" to refer to this directory."}]},{"type":"heading","anchor":"docker-composeyml","text":"docker-compose.yml","level":3},{"type":"paragraph","inlineContent":[{"text":"This docker compose configuration sets up all Vernissage containers. It uses environment variables defined in ","type":"text"},{"inlineContent":[{"type":"text","text":".env"}],"type":"emphasis"},{"type":"text","text":". Please see "},{"inlineContent":[{"type":"text","text":".env"}],"type":"emphasis"},{"type":"text","text":" below."}]},{"inlineContent":[{"type":"text","text":"In a standard deployment little to no changes to this docker compose configuration are necessary."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"Also included is a standard ","type":"text"},{"type":"codeVoice","code":"redis-server"},{"type":"text","text":" container. Beyond that a "},{"inlineContent":[{"type":"text","text":"PostgreSQL"}],"type":"strong"},{"text":" database and ","type":"text"},{"type":"strong","inlineContent":[{"type":"text","text":"S3"}]},{"type":"text","text":" storage are needed, which are not part of this docker compose configuration."}]},{"type":"paragraph","inlineContent":[{"text":"Copy all of the following to ","type":"text"},{"inlineContent":[{"type":"text","text":"HOME"}],"type":"strong"},{"type":"codeVoice","code":"\/docker-compose.yml"},{"type":"text","text":":"}]},{"code":["services:","  api:","    image: mczachurski\/vernissage-server:${DOCKER_TAG:-latest}","    restart: always","    healthcheck:","      test: curl --output \/dev\/null --silent --head --fail http:\/\/host.docker.internal:8080","      interval: 5s","    env_file: \".env\"","    logging: &log-syslog","      driver: syslog","      options:","        tag: \"{{.Name}}\"","    depends_on:","      redis:","        condition: service_healthy","    networks:","      ip6net:","        aliases:","          - vernissage-api.internal","          - host.docker.internal","","  web:","    image: mczachurski\/vernissage-web:${DOCKER_TAG:-latest}","    restart: always","    env_file: \".env\"","    depends_on:","      api:","        condition: service_started","    logging: *log-syslog","    networks:","      ip6net:","        aliases:","          - vernissage-web.internal","          - host.docker.internal","","  proxy:","    image: mczachurski\/vernissage-proxy:${DOCKER_TAG:-latest}","    restart: always","    ports:","      - \"${EXPOSED_PORT:-8080}:8080\"","    logging: *log-syslog","    depends_on:","      web:","        condition: service_started","    networks:","      ip6net:","        aliases:","          - vernissage-proxy.internal","          - host.docker.internal","","  push:","    image: mczachurski\/vernissage-push:${DOCKER_TAG:-latest}","    restart: always","    healthcheck: ","      test: curl --output \/dev\/null --silent --head --fail http:\/\/host.docker.internal:3000","      interval: 5s","    env_file: \".env\"","    logging: *log-syslog","    depends_on:","      api:","        condition: service_started","    networks:","      ip6net:","        aliases:","          - vernissage-push.internal","          - host.docker.internal","    ","  redis:","    image: redis","    restart: always","    healthcheck:","      test: redis-cli ping | grep PONG","      interval: 1s","      timeout: 3s","      retries: 5","    command: redis-server","    logging: *log-syslog","    networks:","      ip6net:","        aliases:","          - vernissage-redis.internal","          - host.docker.internal","","networks:","   ip6net:","     enable_ipv6: true","     ipam:","       config:","         - subnet: ${IPV6_SUBNET:-2001:db8::\/64}"],"syntax":null,"type":"codeListing"},{"text":".env","anchor":"env","type":"heading","level":3},{"type":"paragraph","inlineContent":[{"type":"text","text":"This is the environment configuration for Vernissage."}]},{"inlineContent":[{"text":"The passwords below are examples. Please ","type":"text"},{"type":"strong","inlineContent":[{"type":"text","text":"do not adopt these in your installation"}]},{"text":", but generate your own.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"Copy all of the following to "},{"type":"strong","inlineContent":[{"type":"text","text":"HOME"}]},{"type":"codeVoice","code":"\/.env"},{"text":":","type":"text"}],"type":"paragraph"},{"syntax":null,"type":"codeListing","code":["########################################################################","# SERVER","","# the address under which your Vernissage server is accessible on the internet","VERNISSAGE_BASEADDRESS=https:\/\/vernissage.example.com","","# connection string to your postgres database","# in the format postgres:\/\/user:password@host:port\/database","# if omited Vernissage creates a local sqlite database (not recommended)","VERNISSAGE_CONNECTIONSTRING=postgres:\/\/vernissage-user:P4s5w0rdXaXi93EJF1XaBH8b7yhLQMm7nBzfozh@host:5432\/vernissage-db","","# api url to your S3 storage","# if omited Vernissage uses a local storage directory (not recommended)","VERNISSAGE_S3ADDRESS=https:\/\/minio.example.com","","# region of your S3 bucket in Amazon AWS","# if set VERNISSAGE_S3ADDRESS is overwritten to connect to Amazon AWS","# VERNISSAGE_S3REGION=","","# name of your S3 bucket","VERNISSAGE_S3BUCKET=vernissage","","# accesskey and secret to your S3 storage","VERNISSAGE_S3ACCESSKEYID=AcC3s5k3yXDqIV3t6wXF","VERNISSAGE_S3SECRETACCESSKEY=53cR3tXHuhiSoY7bXxbfTbKJS2vdKmlT6vs3kFdb","","# connection string to your redis server","# no need to change if the preconfigured redis from docker-compose.yml is used","VERNISSAGE_QUEUEURL=redis:\/\/vernissage-redis.internal:6379","","# set to debug to increase the log output","#LOG_LEVEL=debug","","","########################################################################","# WEB","","# adress to add to the Content-Security-Policy-headers to access files","# on your S3 storage. Normaly the same as VERNISSAGE_S3ADDRESS","VERNISSAGE_CSP_IMG=https:\/\/minio.example.com","","","########################################################################","# PROXY","","# exposed port under which the proxy will be accessible. mostly used for","# a nginx reverse proxy configuration on the host. default: 8080","#EXPOSED_PORT=8080","","","########################################################################","# PUSH","","# random, password like string","# must be the same as in \"WebPush service secret key\" from \/settings","VPUSH_KEY=vPu5h_K3yX3673hg627JZW72HD6738bz76HDE73JEzbhzFGIB75zgR5","","","########################################################################","# GLOBAL","","# tag (\"version\") of docker containers to use. defaults to \"latest\"","# `docker compose pull` after changing this value","#DOCKER_TAG=latest","","# subnet for internaly used IPv6 adresses","# defaults to 2001:db8::\/64","#IPV6_SUBNET=2001:db8::\/64"]},{"inlineContent":[{"inlineContent":[{"text":"Important:","type":"text"}],"type":"strong"},{"text":" Don’t forget to ","type":"text"},{"type":"codeVoice","code":"chmod 600 .env"},{"text":" to protect the passwords herein.","type":"text"}],"type":"paragraph"},{"text":"Running your deployment","type":"heading","level":2,"anchor":"Running-your-deployment"},{"type":"paragraph","inlineContent":[{"text":"To startup Vernissage you need only run the ","type":"text"},{"code":"docker compose up -d","type":"codeVoice"},{"type":"text","text":" command from "},{"inlineContent":[{"text":"HOME","type":"text"}],"type":"strong"}]},{"syntax":null,"code":["cd HOME","docker compose up -d"],"type":"codeListing"},{"anchor":"Other-useful-commands","level":2,"type":"heading","text":"Other useful commands"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Always "},{"code":"cd HOME","type":"codeVoice"},{"text":" before issuing one of the following commands","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Shutdown Vernissage: "},{"code":"docker compose down","type":"codeVoice"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Restart Vernissage: ","type":"text"},{"type":"codeVoice","code":"docker compose down && docker compose up -d"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Force update and restart: ","type":"text"},{"code":"docker compose down && docker compose pull && docker compose up -d","type":"codeVoice"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Quick status: "},{"type":"codeVoice","code":"docker ps --format '{{.Names}}\\t{{.Status}}' | grep $(basename $(pwd))-"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"View the running logs: ","type":"text"},{"type":"codeVoice","code":"docker compose logs -f"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"text":"The containers also log to your syslog daemon","type":"text"}]},{"anchor":"Additional-notes","type":"heading","text":"Additional notes","level":2},{"anchor":"systemd-configuration","type":"heading","level":3,"text":"systemd configuration"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The containers are configured with "},{"type":"codeVoice","code":"restart: always"},{"type":"text","text":". This also ensures that they are restarted during a reboot and you don’t need to install a systemd service file for that purpose."}]},{"type":"heading","text":"Using local storage","level":3,"anchor":"Using-local-storage"},{"type":"paragraph","inlineContent":[{"type":"text","text":"We strongly encourage you to use S3 storage instead of local storage. It is indeed possible to use local storage (a directory), but additional configuration is needed. Your reverse proxy would need to expose the local storage to the internet. As of now some Vernissage processes rely on the use of S3 storage. Local storage should only be used for testing purposes."}]},{"text":"reverse proxy configuration","type":"heading","anchor":"reverse-proxy-configuration","level":3},{"type":"paragraph","inlineContent":[{"type":"text","text":"You may need to reverse proxy to Vernissage on the host system. The configuration of a reverse proxy goes beyond the purpose of this documentation, but here’s a snippet you may find useful to configure "},{"type":"strong","inlineContent":[{"type":"text","text":"nginx"}]},{"type":"text","text":":"}]},{"type":"codeListing","code":["server {","    listen 443 ssl;","    listen [::]:443 ssl;","","    server_name vernissage.example.com;","    ","    location \/ {","        # change 8080 to the EXPOSED_PORT from .env","        proxy_pass http:\/\/127.0.0.1:8080; ","        ","        proxy_set_header X-Forwarded-For $remote_addr;","        proxy_set_header Host $host;","        proxy_set_header Upgrade $http_upgrade;","        proxy_set_header Connection \"upgrade\";","        proxy_pass_request_headers on;","        ","        proxy_cache_bypass $http_upgrade;","    }","    # change to the desired max image filesize","    # \"Maximum file size\" in \/settings mustn't be bigger than this value","    client_max_body_size 40M;","","    ssl_certificate ...     # certbot can help with that","    ssl_certificate_key ... # certbot can help with that","}"],"syntax":null}]}],"hierarchy":{"paths":[["doc:\/\/VernissageServer\/documentation\/VernissageServer"]]},"references":{"doc://VernissageServer/documentation/VernissageServer":{"abstract":[{"text":"Application which is main API component for Vernissage photos sharing platform.","type":"text"}],"type":"topic","kind":"symbol","title":"VernissageServer","identifier":"doc:\/\/VernissageServer\/documentation\/VernissageServer","role":"collection","url":"\/documentation\/vernissageserver"},"doc://VernissageServer/documentation/VernissageServer/HostVernissageServer":{"url":"\/documentation\/vernissageserver\/hostvernissageserver","title":"Host Vernissage Server (API)","identifier":"doc:\/\/VernissageServer\/documentation\/VernissageServer\/HostVernissageServer","kind":"article","type":"topic","abstract":[{"text":"Application which is main API component for Vernissage photos sharing platform.","type":"text"}],"role":"article","images":[{"identifier":"host-server-card.jpg","type":"card"}]},"doc://VernissageServer/documentation/VernissageServer/HostVernissageWeb":{"type":"topic","identifier":"doc:\/\/VernissageServer\/documentation\/VernissageServer\/HostVernissageWeb","url":"\/documentation\/vernissageserver\/hostvernissageweb","abstract":[{"type":"text","text":"Application which is Web component for Vernissage photos sharing platform."}],"role":"article","title":"Host Vernissage WEB","kind":"article","images":[{"identifier":"host-web-card.jpg","type":"card"}]},"host-server-card.jpg":{"alt":"The profile image for server documentation.","identifier":"host-server-card.jpg","variants":[{"traits":["2x","light"],"url":"\/images\/VernissageServer\/host-server-card@2x.jpg"}],"type":"image"},"host-web-card.jpg":{"alt":"The profile image for web documentation.","identifier":"host-web-card.jpg","variants":[{"url":"\/images\/VernissageServer\/host-web-card@2x.jpg","traits":["2x","light"]}],"type":"image"},"doc://VernissageServer/documentation/VernissageServer/ContentFeeds":{"url":"\/documentation\/vernissageserver\/contentfeeds","title":"Content feeds (RSS\/Atom)","identifier":"doc:\/\/VernissageServer\/documentation\/VernissageServer\/ContentFeeds","type":"topic","kind":"article","abstract":[{"type":"strong","inlineContent":[{"type":"text","text":"RSS"}]},{"type":"text","text":" (Really Simple Syndication) and "},{"type":"strong","inlineContent":[{"type":"text","text":"Atom"}]},{"type":"text","text":" are widely used web feed formats that allow users to subscribe to updates from websites in an organized and automated way. These protocols enable seamless content consumption through feed readers, making it easier to stay up to date with new posts, images, and other shared content without manually visiting a website."}],"role":"article"},"doc://VernissageServer/documentation/VernissageServer/BuildDocumentation":{"type":"topic","identifier":"doc:\/\/VernissageServer\/documentation\/VernissageServer\/BuildDocumentation","url":"\/documentation\/vernissageserver\/builddocumentation","abstract":[{"type":"text","text":"This documentation is created by DocC tool."}],"role":"article","title":"Build the documentation","kind":"article"}}}